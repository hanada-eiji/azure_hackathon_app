<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title>nm_project</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="./index.css">
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.23.2/vuedraggable.umd.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>


<script>
  // localStorage内の情報とチェック
  function storageGetTodo(){
    if(localStorage.getItem('todo')){
      let getjson = localStorage.getItem('todo');
      let todoStrage = JSON.parse(getjson);
      return todoStrage;
    }else{
      return null;
    }
  }
  function storageGetDone　(){
    if(localStorage.getItem('done')){
      let getjson = localStorage.getItem('done');
      let doneStrage = JSON.parse(getjson);
      return doneStrage;
    }else{
      return null;
    }
  }

  

  window.onload=function(){

    const draggable = window['vuedraggable'];

    console.log(draggable);
    new Vue({
      el:'#app',
      components: {
        'draggable': draggable,
      },
      data:{
        addTask:'',
        todoList:[
          // {id:null,done: false, text: "", time: null}
        ],
        doneList:[
        ],
        show: false,
        title:"",
        prefecture:"",
        disc:"",
        details: [
          {
            id: 1,
            place: "",
            description: "",
            startTime: "",
            endTime:""
          }
        ]
      },
      created() {
        // localStorage内のデータ格納
        let todoStrage=storageGetTodo();
        let doneStrage=storageGetDone();

        if(todoStrage){
          for(let i=0;i<todoStrage.length;++i){
            this.todoList.push(todoStrage[i]);
          }
        }
        if(doneStrage){
          for(let i=0;i<doneStrage.length;++i){
            this.doneList.push(doneStrage[i]);
          }
        }
      },
      methods: {
        addTodoList:function(){
          if(this.addTask){
            let addTodo={done:false,text:this.addTask,time:null};
            this.todoList.push(addTodo);

            let setjson=JSON.stringify(this.todoList);
            localStorage.setItem('todo',setjson);

            this.addTask='';
          }
        },
        onEnd: function(originalEvent){
          console.log(this.todoList);//originalEventは イベントを取得できる
          console.log(originalEvent);//originalEventは イベントを取得できる
        },
        addForm() {
          const additionalForm = {
            place: "",
            description: "",
            time: ""
          }
          this.details.push(additionalForm);
        },
        deleteForm(id) {
          this.details.splice(id, 1);
        },
        sendForm(){
          let sendPlane={
            title:this.title,
            summary:this.disc,
            prefecture:this.prefecture,
            details:this.details
          };
          axios.post('https://jsonplaceholder.typicode.com/users',{
            sendPlane
          })
          .then(response => this.users.unshift(response.data))
          .catch(error => console.log(error))    
        }
      },
      computed:{
        remainingTodo:function(){
          return this.todoList.length;
        },
        remainingDone:function(){
          return this.doneList.length;
        },
        label: function() {
          return this.show ? "閉じる" : "プラン提案";
        }
      },
      watch:{
        todoList:function(){
          // todoListをfalseにセット
          for(let i=0;i<this.todoList.length;++i){
            this.todoList[i]['done']=false;
          }
          // localStorageに格納
          let setjson=JSON.stringify(this.todoList);
          localStorage.setItem('todo',setjson);
          console.log(this.todoList);
        },
        doneList:function(){
          // doneListにtrueを格納
          for(let i=0;i<this.doneList.length;++i){
            this.doneList[i]['done']=true;
          }
          // localStorageに格納
          let setjson=JSON.stringify(this.doneList);
          localStorage.setItem('done',setjson);
        },
        
      }
    })
  }
  
</script>
</head>
<body id="" class="nav-md">
  <div id="app">
    <h2>triptoritori</h2>
    <div class="">
    </div>
    <button v-on:click="show = !show">
      {{ label }}
    </button>
    <transition name="slide">
      <div v-if="show" class="panel">
        <div class="input-row">
          <p class="input-text">タイトル</p>
          <input class="input-text-area" v-model="title" type="text" name="title"/>
        </div>
        <div class="input-row">
          <p class="input-text">都道府県</p>
          <input class="input-text-area" v-model="prefecture" type="text" name="prefecture"/>
        </div>
        <div class="input-row">
          <p class="input-text">概要</p>
          <textarea class="input-text-area" v-model="disc" name="disc">
          </textarea>
        </div>
        <div class="input-row">
          <p class="input-text">詳細</p>
          <div class="input-detail-area">
            <div class="input-row">
              <p class="input-text-detail">場所
                <input class="input-text-area-detail" v-model='details[0].place' type="text" name=""/>
              </p>
            </div>
            <div class="input-row">
              <p class="input-text-detail">時間
                <input class="input-time-area-detail" v-model='details[0].startTime' type="time" name=""/>
                〜
                <input class="input-time-area-detail" v-model='details[0].endTime' type="time" name=""/>
              </p>
            </div>
            <div class="input-row">
              <p class="input-text-detail">備考
                <input class="input-text-area-detail" v-model='details[0].description' type="text" name=""/>
              </p>
            </div>
          </div>
        </div>
        <div class="commands">
          <button class="add-btn" v-on:click="addForm">追加</button>
        </div>
        <div v-for="(detail,index) in details">

          <div v-if="index!=0" class="input-detail-area">
            <div class="input-row">
              <p class="input-text-detail">場所
                <input class="input-text-area-detail" v-model='detail.place' type="text" name="title"/>
              </p>
            </div>
            <div class="input-row">
              <p class="input-text-detail">時間
                <input class="input-time-area-detail" v-model='detail.startTime' type="time" name="title"/>
                〜
                <input class="input-time-area-detail" v-model='detail.endTime' type="time" name="title"/>
              </p>
            </div>
            <div class="input-row">
              <p class="input-text-detail">備考
                <input class="input-text-area-detail" v-model='detail.description' type="text" name="title"/>
              </p>
            </div>
          </div>

          <div v-if="index!=0" class="commands">
            <button class="del-btn" v-on:click="deleteForm(index)">削除</button>
          </div>
          
        </div>
        <p class="btn-center">
        <button class="send-btn" v-on:click="sendForm">投稿</button>
        </p>
      </div>
    </transition>

    <div id="plan-box">
      <div class="plan-title">
        <h2>提案プラン</h2>
      </div>
      <draggable :list="todoList" class="plan-body" :options='{group:"group1",animation:300}'>
        <div v-for="todo in todoList" class="list-item" v-if="remainingTodo!=0">
          {{todo.text}}
        </div>

        <div v-if="remainingTodo==0">
          <p class="list-nonitem">提案プランがありません</p>
        </div>
      </draggable>
    </div>

  </div>
  
    
  
</body>
</html>
